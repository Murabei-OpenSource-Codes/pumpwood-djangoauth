# Generated by Django 5.1.3 on 2025-02-17 16:38

from django.db import migrations


def populate_groups_data(apps, schema_editor):
    """Populate user groups data for pumpwood."""
    # Load models from api_permission
    PumpwoodPermissionGroup = apps.get_model(
        'api_permission', 'PumpwoodPermissionGroup')
    PumpwoodPermissionUserGroupM2M = apps.get_model(
        'api_permission', 'PumpwoodPermissionUserGroupM2M')
    PumpwoodPermissionPolicyGroupM2M = apps.get_model(
        'api_permission', 'PumpwoodPermissionPolicyGroupM2M')

    # Load models from groups
    PumpwoodUserGroup = apps.get_model(
        'groups', 'PumpwoodUserGroup')
    PumpwoodUserGroupM2M = apps.get_model(
        'groups', 'PumpwoodUserGroupM2M')

    # Loop on all permission groups an convert them to user group
    for p_group in PumpwoodPermissionGroup.objects.all():
        new_user_group = PumpwoodUserGroup(
            description=p_group.description, notes=p_group.notes,
            dimensions=p_group.dimensions, extra_info=p_group.extra_info,
            updated_by=p_group.updated_by, updated_at=p_group.updated_at)
        new_user_group.save()
        users_at_group_set = PumpwoodPermissionUserGroupM2M.objects.filter(
            group=p_group)
        for user in users_at_group_set:
            new_user_m2m = PumpwoodUserGroupM2M(
                user=user.user, group=new_user_group,
                extra_info=user.extra_info, updated_by=user.updated_by,
                updated_at=user.updated_at)
            new_user_m2m.save()

        # Update relation
        PumpwoodPermissionPolicyGroupM2M.objects\
            .filter(group_bk=p_group)\
            .update(group=new_user_group)


class Migration(migrations.Migration):
    """Django Migration class."""

    dependencies = [
        ('api_permission',
         '0011_pumpwoodpermissionpolicygroupm2m_group_and_more'),
    ]

    operations = [
        migrations.RunPython(populate_groups_data),
    ]
