# Generated by Django 3.2.6 on 2024-04-01 22:16

from django.db import migrations


#######################
# View SQL definition #
drop_view = "DROP VIEW IF EXISTS public.api_permission__list_all_permissions;"
view_sql = """
CREATE VIEW public.api_permission__list_all_permissions AS
SELECT
  'user_general' AS policy_type,
  policy_user_m2m.user_id,
  NULL::bigint AS group_id,
  policy_user_m2m.priority,
  policy_user_m2m.general_policy,
  NULL::bigint AS policy_id,
  desc_route.id AS route_id,
  desc_route.route_name AS route_name,
  -- desc_policy.*,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_list,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_list_without_pag,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_retrieve,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_retrieve_file,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete_many,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete_file,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_save,
  CASE
    WHEN policy_user_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_user_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_run_actions
FROM public.api_permission__policy_user_m2m AS policy_user_m2m
CROSS JOIN (
    SELECT *
    FROM public.pumpwood__route
    WHERE route_type = 'endpoint'
) AS desc_route
WHERE policy_user_m2m.general_policy IN ('read', 'write')

UNION

-- Custom User
SELECT
  'user_custom' AS policy_type,
  policy_user_m2m.user_id AS user_id,
  NULL::bigint AS group_id,
  policy_user_m2m.priority,
  policy_user_m2m.general_policy,
  desc_policy.id AS policy_id,
  desc_policy.route_id AS route_id,
  desc_route.route_name AS route_name,
  desc_policy.can_list,
  desc_policy.can_list_without_pag,
  desc_policy.can_retrieve,
  desc_policy.can_retrieve_file,
  desc_policy.can_delete,
  desc_policy.can_delete_many,
  desc_policy.can_delete_file,
  desc_policy.can_save,
  desc_policy.can_run_actions
FROM public.api_permission__policy_user_m2m AS policy_user_m2m
JOIN public.api_permission__policy AS desc_policy
	ON policy_user_m2m.custom_policy_id = desc_policy.id
JOIN public.pumpwood__route AS desc_route
  ON desc_route.id = desc_policy.route_id
WHERE policy_user_m2m.general_policy = 'custom'

UNION

-----------------------
-- Group permissions --
-- General Policy Group
SELECT
  'group_general' AS policy_type,
  user_group_m2m.user_id,
  user_group_m2m.group_id,
  policy_group_m2m.priority,
  policy_group_m2m.general_policy,
  NULL AS policy_id,
  desc_route.id AS route_id,
  desc_route.route_name AS route_name,
  -- desc_policy.*,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_list,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_list_without_pag,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_retrieve,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'allow'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'no_change'
    ELSE 'error'
  END AS can_retrieve_file,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete_many,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_delete_file,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_save,
  CASE
    WHEN policy_group_m2m.general_policy = 'read' THEN 'no_change'
    WHEN policy_group_m2m.general_policy = 'write' THEN 'allow'
    ELSE 'error'
  END AS can_run_actions
FROM public.api_permission__policy_group_m2m AS policy_group_m2m
JOIN public.api_permission__user_group_m2m AS user_group_m2m
	ON user_group_m2m.group_id = policy_group_m2m.group_id
CROSS JOIN (
    SELECT *
    FROM public.pumpwood__route
    WHERE route_type = 'endpoint'
) AS desc_route
WHERE policy_group_m2m.general_policy IN ('read', 'write')

UNION

-- Custom Group
SELECT
  'group_custom' AS policy_type,
  user_group_m2m.user_id,
  user_group_m2m.group_id,
  policy_group_m2m.priority,
  policy_group_m2m.general_policy,
  desc_policy.id AS policy_id,
  desc_policy.route_id AS route_id,
  desc_route.route_name AS route_name,
  desc_policy.can_list,
  desc_policy.can_list_without_pag,
  desc_policy.can_retrieve,
  desc_policy.can_retrieve_file,
  desc_policy.can_delete,
  desc_policy.can_delete_many,
  desc_policy.can_delete_file,
  desc_policy.can_save,
  desc_policy.can_run_actions
FROM public.api_permission__policy_group_m2m AS policy_group_m2m
JOIN public.api_permission__policy AS desc_policy
    ON policy_group_m2m.custom_policy_id = desc_policy.id
JOIN public.pumpwood__route AS desc_route
  ON desc_route.id = desc_policy.route_id
JOIN public.api_permission__user_group_m2m AS user_group_m2m
    ON user_group_m2m.group_id = policy_group_m2m.group_id
WHERE policy_group_m2m.general_policy = 'custom';
"""
#######################


class Migration(migrations.Migration):

    dependencies = [
        ('api_permission', '0008_auto_20240401_2139'),
    ]

    operations = [
        migrations.RunSQL(drop_view),
        migrations.RunSQL(view_sql)
    ]
